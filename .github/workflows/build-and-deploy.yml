name: Build & Deploy

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  # ✅ Manual run button in GitHub Actions
  workflow_dispatch:
    inputs:
      target:
        description: "What to deploy?"
        type: choice
        required: true
        default: both
        options:
          - both
          - server
          - client

# Allow pushing to branches (server/web)
permissions:
  contents: write

# Avoid concurrent deployments stomping each other (force-push)
concurrency:
  group: build-and-deploy-${{ github.ref }}
  cancel-in-progress: false

jobs:
  # ─────────────────────────────────────────────────────────────────────────────
  # JOB 1: Deploy Server
  # - Runs on:
  #   - push to main
  #   - manual dispatch when target is server or both
  # ─────────────────────────────────────────────────────────────────────────────
  deploy-server:
    name: Deploy Server
    runs-on: ubuntu-latest
    if: |
      (github.event_name == 'push' && github.ref == 'refs/heads/main') ||
      (github.event_name == 'workflow_dispatch' && (inputs.target == 'server' || inputs.target == 'both'))

    steps:
      - name: Checkout source
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18.x
          cache: npm
          cache-dependency-path: server/package-lock.json

      - name: Install server dependencies
        working-directory: server
        run: npm ci

      - name: Build server
        working-directory: server
        run: npm run build

      - name: Push to server branch
        run: |
          set -euo pipefail
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git config --global user.name  "github-actions[bot]"

          # 1️⃣ Save production files to temp
          mkdir -p /tmp/server-deploy
          cp -r server/dist/* /tmp/server-deploy/
          cp server/package.json /tmp/server-deploy/
          cp server/package-lock.json /tmp/server-deploy/
          cat > /tmp/server-deploy/Procfile << 'EOF'
          web: node dist/index.js
          EOF

          # 2️⃣ Create clean orphan branch
          git checkout --orphan server-new-clean
          git rm -rf . --cached 2>/dev/null || true

          # 3️⃣ DELETE everything from disk (BUT KEEP .git)
          find . -maxdepth 1 ! -name '.' ! -name '.git' -exec rm -rf {} + 2>/dev/null || true

          # 4️⃣ Restore ONLY production files
          cp -r /tmp/server-deploy/* .

          # 5️⃣ Commit and merge
          git add -A
          if [ -z "$(git diff --cached --name-only)" ]; then
            echo "⏭️  No changes to deploy (server)"
            exit 0
          fi

          git commit -m "deploy(server): $(date -u +'%Y-%m-%d %H:%M UTC') [skip ci]"
          git branch -M server-new-clean server
          git push origin server --force

  # ─────────────────────────────────────────────────────────────────────────────
  # JOB 2: Deploy Client
  # - Runs on:
  #   - push to main
  #   - manual dispatch when target is client or both
  # ─────────────────────────────────────────────────────────────────────────────
  deploy-client:
    name: Deploy Client
    runs-on: ubuntu-latest
    if: |
      (github.event_name == 'push' && github.ref == 'refs/heads/main') ||
      (github.event_name == 'workflow_dispatch' && (inputs.target == 'client' || inputs.target == 'both'))

    steps:
      - name: Checkout source
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18.x
          cache: npm
          cache-dependency-path: client/package-lock.json

      - name: Install client dependencies
        working-directory: client
        run: npm ci

      - name: Build client
        working-directory: client
        run: npm run build
        env:
          # Add these secrets in: GitHub repo → Settings → Secrets → Actions
          VITE_GRAPHQL_HTTP_URL: ${{ secrets.VITE_GRAPHQL_HTTP_URL }}
          VITE_GRAPHQL_WS_URL:   ${{ secrets.VITE_GRAPHQL_WS_URL }}

      - name: Verify dist folder
        run: |
          set -euo pipefail
          if [ ! -d "client/dist" ]; then
            echo "❌ Build failed: client/dist not found"
            exit 1
          fi
          echo "✅ Client build successful:"
          du -sh client/dist
          find client/dist -type f | wc -l

      - name: Publish to web branch (clean orphan)
        run: |
          set -euo pipefail
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git config --global user.name  "github-actions[bot]"

          # 1️⃣ Save dist files to temp
          mkdir -p /tmp/client-deploy
          cp -r client/dist/* /tmp/client-deploy/

          # 2️⃣ Create clean orphan branch
          git checkout --orphan web-new-clean
          git rm -rf . --cached 2>/dev/null || true

          # 3️⃣ DELETE everything from disk (BUT KEEP .git)
          find . -maxdepth 1 ! -name '.' ! -name '.git' -exec rm -rf {} + 2>/dev/null || true

          # 4️⃣ Restore ONLY dist files
          cp -r /tmp/client-deploy/* .

          # 5️⃣ Commit and merge
          git add -A
          if [ -z "$(git diff --cached --name-only)" ]; then
            echo "⏭️  No changes to deploy (client)"
            exit 0
          fi

          git commit -m "deploy(client): $(date -u +'%Y-%m-%d %H:%M UTC') [skip ci]"
          git branch -M web-new-clean web
          git push origin web --force